<!--
  =========================================================
* Brainchop - v1.1.0
=========================================================

* Discription:  A user interface for whole brain segmentation
*               Input shape : [1, D, H, W, 1] e.g. [1, 256, 256, 256, 1]                
*               Model : Meshnet or similar lightweigth models    
*
* Authors:  Mohamed Masoud  and Sergey Plis  - 2022
=========================================================



=========================================================
           Brainchop for 3D Brain Segmentation
=========================================================
--> 
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Brainchop </title>
  <link rel="apple-touch-icon" sizes="180x180" href="style/favicon_io/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="style/favicon_io/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="style/favicon_io/favicon-16x16.png">
  <link rel="manifest" href="style/favicon_io/site.webmanifest">

  <link rel="stylesheet" href="style/w3.css">
  <link rel="stylesheet" href="style/font-awesome-4.7.0/css/font-awesome.min.css"/>   
  <link rel="stylesheet" type="text/css" href="lib/webix/codebase/webix.css"/> 
  <link rel="stylesheet" type="text/css" href="lib/papaya_lib/papaya.css" />
  <link rel="stylesheet" type="text/css" href="style/style.css">  

<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>


  <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js" type="text/javascript"></script>
  <script src="https://docs.opencv.org/3.4.0/opencv.js"></script> 
  <script src="https://www.lactame.com/lib/image-js/0.21.2/image.min.js"></script>  

  <script src="lib/webix/codebase/webix.js"></script>  
  <script src="lib/tf.min.js"></script>   
  <script src="lib/float16.js"></script>  

  <script type="text/javascript" src="lib/papaya_lib/papaya.js"></script>
  
  <script type="text/javascript" src="js/nifti-reader.js"></script>
  <script type="text/javascript" src="js/nifti-reader-min.js"></script>
  <script type="text/javascript" src="js/connectedComponents3DAll.js"></script>
  <script type="text/javascript" src="js/mainParameters.js"></script>  
  <script type="text/javascript" src="js/mainMeshNetFunctions.js"></script>
  <script type="text/javascript" src="js/mainNiftiReadingFunctions.js"></script> 
  <script type="text/javascript" src="js/mainTypes.js"></script> 

  
  <script type="text/javascript" src="js/checkCompatibility.js"></script> 

  <script type="text/javascript" src="js/utilities.js"></script>  
  <script type="text/javascript"  src="https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js"></script>
  <script type="text/javascript" src="js/mri_convert.js"></script>  



    <style>
      .grid-container {
        display: grid;
        grid-template-columns: auto;
        padding: 1vh;
      }
      .grid-item {
        background-color: rgba(255, 255, 255, 0.8);
        border: 0px solid rgba(0, 0, 0, 0.8);
        padding: 1vh;
        width: 40vw;
        height: auto;
        font-size: 15px;
        text-align: center;
      }


      .toolbarclass {
        background-color: white !important;
        font-weight: bold;
        box-shadow: 5px 5px;
      } 

      .titleclass {
        font-style: italic;
        font-weight: bold;
        color: black !important;
      }  

      .headerclass {
            border-left: 10px solid black!important;
            background: #f3f3f6a3!important;
            margin-left: 0!important;
            width: 100%!important;
            color: black!important;
            font-weight: bold;
            border-left-color: black!important;
      }

      .windowtitleclass {
        background-color: #ccc !important;
        box-shadow: none,
      }      

      .webixbg .webix_view{
        background-color:black !important;
        box-shadow:none;
        }

      #feedbackId{
        cursor: pointer;
        margin-right: 20px;
      }

      #githubId{
        cursor: pointer;
        margin-right: 20px;
      }
      .customTheme {
          font-weight: bold;
          background-color: black;
          color:  white;
      }

      #annotOfContainer_0 {
          /*font-weight: bold;*/
          background-color: black;
          color:  white;
          text-align: center;
          height: 3vh;
      }

      #annotOfContainer_1 {
          /*font-weight: bold;*/
          background-color: black;
          color:  white;
          text-align: center;
          height: 3vh;
      }

      .bt_1 button.webix_button{
        background: #396D9E;
        background: -moz-linear-gradient(top, #5D91C3 0% , #396D9E 100%);
        background: -webkit-gradient(linear, left top, left bottom, color-stop(0,#5D91C3), color-stop(1, black));
        border:1px solid #396D9E;
        text-shadow: 0 -1px #134471;
        box-shadow: inset 0px 1px 10px #8eb3d5;
        -webkit-box-shadow: inset 0px 1px 1px #8eb3d5;
        color:#FFFFFF;
        font-size: 13px;
      }
      .bt_1 button:active{
        background: #396D9E !important;
      }    


    </style>

      
</head>
   
<body>
 
 <script type="text/javascript">


  webix.ready(function () {


      // About Window
      let aboutWindowForm = {view: "form", id: "aboutWindowFormId", elements: [ 

              {  cols: [
                    {   view: "template", template: "Brainchop is an in-browser  automatic segmentation setup for T1 MRI volumes. The tool is an open source and designed to enable you to segment T1 images into regions of interest with a simple interactive interface. The input must be a T1 brain volume in the nifti format. The output may also be downloaded as a nifti file. <br><br> <br><b>Authors:</b> Mohamed Masoud and Sergey Plis (2022).<br> <b>Version:</b> 1.1.0 <br> <b>Funded by:</b>  NIH RF1MH121885. <br><br> <b>Special thanks</b> to Kevin Wang and Alex Fedorov for discussions and pre-trained Meshnet models.<br><br> <b>Affiliation: </b> Center for Translational Research in Neuroimaging and Data Science (<a href='https://trendscenter.org/'>TReNDS</a>) <br><center><img src='style/TReNDS_logo.jpg' width='180' height='60'></img></center>" 
                        
                    }                 

                ]  
                
             },  
       

              {  cols: [
                        {}, 

                        { view:"button", value:"Ok", css:"bt_1", width:100,  
                                align:"center",
                                click: function() {
                                     $$("aboutWindow").hide();
                               }
                        },

                        {}
                       ]
              } 

          ]
       }




      // About Window to select local model
      webix.ui({
                  view:"window",
                  id: "aboutWindow",
                  height:550,
                  width:600,

                  head:{
                      view:"toolbar", css: "toolbarclass", elements:[
                          { type:"header", template:"About", css:"windowtitleclass" },
                          { view:"icon", icon:"wxi-close", click:function(){
                              $$("aboutWindow").hide();
                          } }
                      ]
                  },                  

                  position:"center",
                  body: aboutWindowForm

      })

      
      let about = "Demo of 3D MRI Segmentation. <br>By<br> Mohamed Masoud, Sergey Plis (2021) <br> Grant:  NIH RF1MH121885 ";
       
      aboutClick = () => {
            $$("aboutWindow").show()
      }


      feedbackClick = () => {
                   window.open("https://forms.gle/WzUyVEzgCCY2bHo79");
      }

      githubClick = () => {
                   window.open("https://github.com/neuroneural/brainchop");
      }

      toolbar = {
          view: "toolbar",
          css: "toolbarclass",
          id: "myToolbar",
          rows:[{ cols: 
                  [
                   { view: "label", label: '<img src="style/Artboard2.svg"/>', css: {"color":"black !important", "font-weight": "bold"}, width: 30 },                   
                   { view: "label", label: '<p>Brain<span>chop</span></p>', css: {"margin":"0!important"},  inputWidth: 100, align: "left" },
                   { view: "label", label: '<i id="feedbackId" class="fa fa-pencil-square-o"/>',
                   css: {"color":"black !important", "font-weight": "bold"},  width: 60, align:"right", click: feedbackClick, tooltip:"Feedback" },
                   { view: "button", id: "About", value: "About", css:"bt_1",  width: 100, align: "right", click: aboutClick },
                   { view: "label", label: '<i id="githubId" class="fa fa-github"/>',
                   css: {"color":"black !important", "font-weight": "bold"},  width: 60, align:"right", click: githubClick, tooltip:"GitHub" },                   
                  ]
                }
          ]
      }

     closeMriConvPrgBarWin = () => {
           $$("mriConvPrgBarWin").hide(); 
     } 

 
      // Progress bar for mri_convert.js
     webix.ui({
        view:"window",
        id: "mriConvPrgBarWin",
        height:50,
        width:500,
        position:"center",
        head:false,
        body:{
          template:"  <div class='w3-container' style='margin-top: 1vh;' id='mriConvertProgBarDiv' > <div class='w3-border' > <div class='w3-green' style='height:2vh;width:0%;' id='mriConvertProgBar'></div> </div> </div> "
        }
      });


      let referenceImage = { view: "form",  id: "referenceImage", elements: [ 
              { type:"header", template:"Open Brain T1 MRI", 
                css: "headerclass"
              },

              { cols:[ 
                      {  view: "label", label: "Select NIfTI file",  
                          align: "left"
                      }, 

                      { 
                       view: "uploader" , value: "Browse", width: 100, id:"imageUploader", 

                       css:"bt_1",
                       align: "left",
                       accept: "image/nii, image/nii.gz",
                       autosend: false, 
                       multiple: false, 
                       on: {        
                              onBeforeFileAdd: function(upload) {        
                                     let file = upload.file;
                                     //--file{name: "test.nii", lastModified: 1548792883000, webkitRelativePath: "", size: 503010, type: ""}
                                     if(file["name"].search(".nii") > 0) {

                                          refFileName = file["name"];

                                          let reader = new FileReader();  

                                          var blob = makeSlice(file, 0, file.size);

                                          reader.onloadend = function(event) {

                                              if (event.target.readyState === FileReader.DONE) {
                                                  //--evt.target.result is :  ArrayBuffer { byteLength: 763810 }

                                                  // params_mri["files"] = [file]; 
                                                  // Or
                                                  params_mri["binaryImages"] = [event.target.result];



                                                  // Set 0 for MRI viewer 
                                                  papaya.Container.resetViewer(0, params_mri);
                                                  papaya.Container.atlas = null;
                                                  // Set 1 for label viewer, need this step to remove startup image
                                                  // papaya.Container.resetViewer(1);
                                                  papayaContainers[1].viewer.resetViewer();
                                                  papayaContainers[1].viewer.canvas.removeEventListener('mousemove', mouseMoveHandler);
                                                  papayaContainers[1].viewer.canvas.removeEventListener('mouseout', mouseOutHandler);

                                                  let startTime = performance.now(); 
                                                  // decompress/check uploaded Nifti data
                                                  rawNiftiData = getNiftiRawData(event.target.result);

                                                  if(rawNiftiData == null) {
                                                      let loadingErrorTxt = "This file not Nifti or corrupted. Please try again";

                                                      webix.alert({
                                                        type:"alert-error",
                                                         width:"35%",
                                                        text: loadingErrorTxt
                                                      });
                                                     
                                                     $$("segmentBtn").disable();
                                                     return 0;
                                                  }

                                                  niftiHeader = readNiftiHeader(rawNiftiData);
                                                  niftiImage = readNiftiImageData(niftiHeader, rawNiftiData); 

                                                  statData["Data_Load"] = ((performance.now() - startTime)/1000).toFixed(4);
                                                  statData["Resampled"] = null;

                                                  statData["File_Type"] =  nifti.isNIFTI1(rawNiftiData) ? "NIFTI-1" : nifti.isNIFTI2(rawNiftiData) ? "NIFTI-2" : "NOT-NIFTI"; 
                                                  statData["Img_Size"] = JSON.stringify([niftiHeader.dims[1], niftiHeader.dims[2], niftiHeader.dims[3]]);  
                                                  statData["Num_Bits_Per_Voxel"] = niftiHeader['numBitsPerVoxel'] ;
                                                  statData["Data_Type_Code"] = niftiHeader['datatypeCode'];
                                                  statData["Vox_Offset"] = niftiHeader['vox_offset'];
                                                  statData["Vox_1mm"] = isVoxelSize1mm(niftiHeader);
                                                  statData["File_Verified"] = isNiftiFileVerified(niftiHeader);                                                  
                                                  //-- Check if Nifti file is already converted and no need to mri_convert.js
                                                  if( ! isNiftiFileVerified(niftiHeader)) {

                                                      let reasonTxt = "", actionTxt = "", actionCounter = 0;
                                                      //-- Check  Nifti file shape
                                                      if( (niftiHeader.dims[1]!= 256) || (niftiHeader.dims[2]!= 256) || (niftiHeader.dims[3]!= 256) ) {
                                                           reasonTxt = " <br> Image shape should be 256x256x256.<br>";
                                                           actionTxt = "reshaped";
                                                           actionCounter += 1;
                                                           $$("segmentBtn").disable();
                                                      } 
                                                      //-- Check  Nifti file data type 
                                                      if ( (niftiHeader['numBitsPerVoxel'] != 8) || (niftiHeader['datatypeCode'] != 2) ) {
                                                           reasonTxt = reasonTxt + " <br> Data type should be integer in range 0-255.<br>";
                                                           if(actionCounter) { actionTxt += "/"  }
                                                           actionTxt += "scaled ";
                                                           actionCounter += 1;                                                           
                                                           $$("segmentBtn").disable();
                                                      }  

                                                      //-- Check  Nifti file data type 
                                                      if ( ! isVoxelSize1mm(niftiHeader)) {
                                                           reasonTxt = reasonTxt + " <br> Voxels should be 1x1x1 mm thickness.<br>";
                                                           if(actionCounter) { actionTxt += "/"  }
                                                           actionTxt += "resampled ";
                                                           actionCounter += 1;                                                           
                                                           $$("segmentBtn").disable();
                                                      } 

                                                      let alertTxt = "MRI needs to be " + actionTxt.bold() + " for proper results. <br>" + reasonTxt.fontcolor("red").bold()  +  " <br> For more information please refer to  <a href='https://github.com/neuroneural/brainchop/wiki/Input-Data' target='_blank'><b>Input Data</b></a> section.";


                                                      webix.confirm({
                                                        title:"",
                                                        ok:"Apply", 
                                                        cancel:"Cancel",
                                                        type: "confirm-error",
                                                        width: 500,
                                                        text: alertTxt
                                                      })
                                                        .then(() => {
                                                               //---
                                                            console.log("Starting mri_convert") 
                                                            let blob = new Blob( params_mri["binaryImages"] , {type: "application/octet-binary;charset=utf-8"});
                                                            let rawImgurl = window.URL.createObjectURL(blob);
                                                             
                                                            mri_convert(rawImgurl, rawNiftiData).then(function(res) {
                                                                rawNiftiData = res;
                                                                niftiHeader = readNiftiHeader(rawNiftiData);
                                                                niftiImage = readNiftiImageData(niftiHeader, rawNiftiData); 

                                                                params_mri["binaryImages"] = [rawNiftiData];
                                                                papaya.Container.resetViewer(0, params_mri);
                                                                
                                                                // If still not correctly converted
                                                                if(! isNiftiFileVerified(niftiHeader)) { 
                                                                      webix.alert(" File can not be resampled. <br> For more options please refer to  <a href='https://github.com/neuroneural/brainchop/wiki/Input-Data' target='_blank'><b>Input Data</b></a> section.");

                                                                      statData["Resampled"] = false;
                                                                      submitTiming2GoogleSheet(statData);

                                                                } else {

                                                                      statData["Resampled"] = true;  
                                                                }
                                                                // enable it for all cases 
                                                                $$("segmentBtn").enable(); 
                                                                  

                                                            });

                                                      })
                                                        .fail(() => {
                                                               //---
                                                               $$("segmentBtn").disable();
                                                               statData["Brainchop_Ver"] = "Cancelled"
                                                               submitTiming2GoogleSheet(statData);
                                                      });

                                                  } else { // Not varified file

                                                                                                                                                
                                                      if(checkGPU()) {
                                                         $$("segmentBtn").enable();
                                                      }
                                                  }

                                                  numOfOverlays = 0;   
                                                  $$("downloadBtn").disable(); 
                                              }
                                         };

                                         reader.readAsArrayBuffer(blob);

                                    } else {
                                      webix.message("Select Nifti file *.nii / *.nii.gz")
                                    
                                    }     
                                    
                                    return false;

                              }
                          }
                      }
                    ] 
               }
         ]
      }


      let modelBrowsingForm = {view: "form", id: "modelBrowsingFormId", elements: [ 
              {  cols: [
                    { view: "label", label: "Model*", align: "left"},                 
                    { view:"icon", id: "modelIconId", icon:"", align: "left"},
                      { 
                       view: "uploader" , value: "Load", width: 100, id:"modelUploader", 

                       css:"bt_1",
                       align: "left",
                       accept: "application/json",
                       autosend: false, 
                       multiple: false, 
                       on: {        
                              onBeforeFileAdd: function(upload) {        
                                     let file = upload.file;
                                     modelFile = file;
                                     console.log("modelFile :", modelFile)
                                     //--file{name: "model.json", lastModified: 1548792883000, webkitRelativePath: "", size: 5030, type: ""}
                                     if(modelFile["name"].search(".json") > 0) {
                                          let reader = new FileReader();  
                                          let blob = makeSlice(file, 0, file.size);
                                          reader.onloadend = function(event) {

                                              if (event.target.readyState === FileReader.DONE) {
                                                  //--evt.target.result is :  ArrayBuffer { byteLength: 763810 }
                                                  $$("modelIconId").config.icon = "wxi-check";
                                                  $$("modelIconId").refresh();                                                  
                                              }
                                         };

                                         reader.readAsArrayBuffer(blob);

                                    } else {
                                      webix.message("Select model json file *.json")
                                    
                                    }     
                                    
                                    return false;

                              }
                          }
                      }


                ]    
             },             

              {  cols: [
                    { view: "label", label: "Weights*", align: "left"},                 
                    { view:"icon", id: "weightsIconId", icon:"", align: "left"},
                     { 
                       view: "uploader" , value: "Load", width: 100, id:"weightUploader", 

                       css:"bt_1",
                       align: "left",
                       accept: "application/bin",
                       autosend: false, 
                       multiple: false, 
                       on: {        
                              onBeforeFileAdd: function(upload) {        
                                      let file = upload.file;
                                      weightFile = file;
                                      console.log("weightFile :", weightFile)
                                      //--file{name: "weights.bin", lastModified: 1548792883000, webkitRelativePath: "", size: 503010, type: ""}
                                     if(weightFile["name"].search(".bin") > 0) {
                                          let reader = new FileReader();  

                                          var blob = makeSlice(file, 0, file.size);

                                          reader.onloadend = function(event) {

                                              if (event.target.readyState === FileReader.DONE) {
                                                  //evt.target.result is :  ArrayBuffer { byteLength: 763810 }
                                                  $$("weightsIconId").config.icon = "wxi-check";
                                                  $$("weightsIconId").refresh();
                                              }
                                         };

                                         reader.readAsArrayBuffer(blob);

                                    } else {
                                      webix.message("Select weights binary file *.bin")
                                    
                                    }     
                                    
                                    return false;
                              }
                          }
                      }
                ]    
             },

              {  cols: [
                    { view: "label", label: "Labels", align: "left"},                 
                    { view:"icon", id: "labelsIconId", icon:"", align: "left"},
                     { 
                       view: "uploader" , value: "Load", width: 100, id:"labelUploader", 

                       css:"bt_1",
                       align: "left",
                       accept: "application/json",
                       autosend: false, 
                       multiple: false, 
                       on: {        
                              onBeforeFileAdd: function(upload) {        
                                      let file = upload.file;
                                      labelFile = file;
                                      console.log("labelFile :", labelFile)
                                      //--file{name: "weights.bin", lastModified: 1548792883000, webkitRelativePath: "", size: 503010, type: ""}
                                     if(labelFile["name"].search(".json") > 0) {
                                          let reader = new FileReader();  

                                          var blob = makeSlice(file, 0, file.size);

                                          reader.onloadend = function(event) {

                                              if (event.target.readyState === FileReader.DONE) {
                                                  //evt.target.result is :  ArrayBuffer { byteLength: 763810 }
                                                  $$("labelsIconId").config.icon = "wxi-check";
                                                  $$("labelsIconId").refresh();
                                              }
                                         };

                                         reader.readAsArrayBuffer(blob);

                                    } else {
                                      webix.message("Select labels json file *.json")
                                    
                                    }     
                                    
                                    return false;
                              }
                          }
                      }
                ]    
             },

              {  cols: [
                    { view: "label", label: "Colors", align: "left"},                 
                    { view:"icon", id: "colorsIconId", icon:"", align: "left"},
                     { 
                       view: "uploader" , value: "Load", width: 100, id:"colorUploader", 

                       css:"bt_1",
                       align: "left",
                       accept: "application/json",
                       autosend: false, 
                       multiple: false, 
                       on: {        
                              onBeforeFileAdd: function(upload) {        
                                      let file = upload.file;
                                      colorFile = file;
                                      console.log("colorFile :", colorFile)
                                      //--file{name: "weights.bin", lastModified: 1548792883000, webkitRelativePath: "", size: 503010, type: ""}
                                     if(colorFile["name"].search(".json") > 0) {
                                          let reader = new FileReader();  

                                          var blob = makeSlice(file, 0, file.size);

                                          reader.onloadend = function(event) {

                                              if (event.target.readyState === FileReader.DONE) {
                                                  //--evt.target.result is :  ArrayBuffer { byteLength: 763810 }
                                                  $$("colorsIconId").config.icon = "wxi-check";
                                                  $$("colorsIconId").refresh();

                                              }
                                         };

                                         reader.readAsArrayBuffer(blob);

                                    } else {
                                      webix.message("Select colors json file *.json")
                                    
                                    }     
                                    return false;
                              }
                          }
                      }
                ]    
             },

              {  cols: [
                    {   view: "label", label: "Transpose Input",  
                        align: "left"
                    }, 

                    { view: "select", 
                      id: "tranposeStatus", 
                      value: 1, 
                      options: ["true", "false"]
                    }                                    

                ]    
             }, 


              {  cols: [
                    {   view: "label", label: "Model Name*",  
                        align: "left"
                    },                 
                    { view: "text", 
                      placeholder: "New Model ",  
                      id: "proposedModelName", 
                      disabled: false,
                      align: "left"
                    }
                ]    
             },              
              {  cols: [
                        {}, 
                          { view:"button", value:"Confirm", css:"bt_1", width:100,  
                                align:"center",
                                click: function() {

                                    if(modelFile && weightFile) {

                                           let newId = parseInt(inferenceModelsList.at(-1)["id"]) + 1;
                                           newId = newId.toString();

                                           // Model list loaded from browsing
                                           browserModelList.push({id: newId, modelFile: modelFile, weightFile: weightFile, colorFile: colorFile, labelFile: labelFile });

                                           let labelFileUrl = null;

                                           if(browserModelList.at(-1)["labelFile"]) {
                                                labelFileUrl = URL.createObjectURL(browserModelList.at(-1)["labelFile"]);
                                           } 

                                           let colorFileUrl = null;

                                           if(browserModelList.at(-1)["colorFile"]) {
                                                colorFileUrl = URL.createObjectURL(browserModelList.at(-1)["colorFile"]);
                                           } 

                                           let newModelName = "New Model " + newId;
                                           if($$("proposedModelName").getValue().length && isLetter($$("proposedModelName").getValue()[0])){
                                                newModelName =   $$("proposedModelName").getValue().trim();
                                                // Check new imported model name possible redundancy
                                                if ( inferenceModelsList.filter(entry => entry.modelName == newModelName).length ) {
                                                      webix.message("Please select unique model name");
                                                      return 0;
                                                }

                                            } else if($$("proposedModelName").getValue().length) {
                                                webix.message("Please select valid model name");
                                                return 0;
                                            } else if(isLetter($$("proposedModelName").getValue()[0])) {
                                                webix.message("Please select model name");
                                                return 0;
                                            }

                                           inferenceModelsList.push({
                                                 id: newId, 
                                                 type: "Segmentation", 
                                                 path: null, 
                                                 modelName: newModelName, 
                                                 labelsPath: labelFileUrl, 
                                                 colorsPath: colorFileUrl, 
                                                 preModelId: null, 
                                                 isBatchOverlapEnable: false, 
                                                 numOverlapBatches: 0, 
                                                 enableTranpose: $$("tranposeStatus").getValue(),
                                                 textureSize: 0,
                                                 warning: null, 
                                                 inferenceDelay: 100,                                                
                                                 description: ""                                            
                                           })


                                           selectModelOptions = getSegmentationFormOptions(inferenceModelsList);
                                           $$("selectModel").config.options = selectModelOptions;
                                           $$("selectModel").config.value = parseInt(newId);
                                           $$("selectModel").refresh();
                                           
                                           $$("modelBrowsingWindow").hide(); 
                                           $$("proposedModelName").setValue("");


                                    } else if(weightFile) { 
                                           webix.message("Please select the model json file");
                                    
                                    } else {
                                           webix.message("Please select the model weights file");
                                    }  
                               }
                           },
                          {}
                       ]
              }      

          ]
       }



      // Model Browsing Window to select local model
      webix.ui({
                  view:"window",
                  id: "modelBrowsingWindow",
                  height:400,
                  width:300,
                  head:{
                      view:"toolbar", css: "toolbarclass", elements:[
                          { type:"header", template:"Load tfjs Model", css:"windowtitleclass" },
                          { view:"icon", icon:"wxi-close", click:function(){
                              $$("modelBrowsingWindow").hide();
                              $$("proposedModelName").setValue("");
                          } }
                      ]
                  },                  

                  position:"center",
                  body: modelBrowsingForm
      })

      // Reset check icon
      $$("modelBrowsingWindow").attachEvent("onShow", function(){
          $$("weightsIconId").config.icon = "";
          $$("modelIconId").config.icon = "";
          $$("weightsIconId").refresh();
          $$("modelIconId").refresh();
          modelFile = null;
          weightFile = null;
          labelFile = null;
          colorFile = null;
      });


      getSegmentationFormOptions = (modelsList) => {
          let selectedOptions = [];

          modelsList.forEach( function(modelEntry) {
             selectedOptions.push({id: modelEntry["id"], value: modelEntry["modelName"], path: modelEntry["path"] });
          })

          selectedOptions.push({id: "Browse...", value: "Browse...", path: null });

          return selectedOptions
      }

      // To load models dynamically from  inferenceModelsList
      let selectModelOptions = getSegmentationFormOptions(inferenceModelsList);
      
      //-- Count total number of models excluding browsing models
      numOfModelsWithoutBrowse =  inferenceModelsList.length;


      onShowWarningCheck = (checkElem) => {
           webix.storage.local.put("noShowWarning", document.getElementById("noShowWarningId").checked);
      }

      fetchModelWarningStatus = () => {
          return webix.storage.local.get("noShowWarning");
      }       

      onShowTooltipCheck = (checkElem) => {
          webix.storage.local.put("noShowTooltip", document.getElementById("noShowTooltipId").checked);

      }

      fetchModelTooltipStatus = () => {
          return webix.storage.local.get("noShowTooltip");
      } 

      getModelinfo = () => {
          let modelDescription = inferenceModelsList[$$("selectModel").getValue() - 1]["description"];
          let info = "No info for this model";
          
          if(modelDescription) {
              info = modelDescription;
          } 

          $$("modelTooltip").show();
          document.getElementById("tooltipDiv").innerHTML = 
          "<i style='font-size:1.4vw'  class='fa fa-info-circle' ></i> <font style='font-size:0.77vw' >&nbsp&nbsp"+ info +" </font>"          
      }



      let Segmentation = {view: "form", id: "Segmentation", elements: [ 
              { type:"header", template:"Segmentation Options",
                css: "headerclass"
              },

              { cols: [

                      { view:"select", 
                        label:"Model", 
                        id: "selectModel",
                        value:2, 
                        options: selectModelOptions,
                        on:{        
                            onChange: function(newValue, oldValue, config) {   
                               const selectedModelEntry = selectModelOptions[this.getValue() - 1]; 

                               if(newValue == "Browse...") {
                                      console.log("Browse selected ..")
                                      $$("modelBrowsingWindow").show();
                                    
                               } else if (selectedModelEntry["path"]) {
                                             modelObject = {};
                                             const modelEntry = selectModelOptions[this.getValue() - 1]; 

                                             let curModelEntry = inferenceModelsList.filter(entry => entry.id == this.getValue().toString())[0];

                                             let noShowWarningStatus = fetchModelWarningStatus();

                                             if(! noShowWarningStatus) {

                                                 if (curModelEntry["warning"] != null) {
                                                        $$("modelTooltip").show();
                                                        document.getElementById("tooltipDiv").innerHTML = 
                                                        "<i style='font-size:1.4vw'  class='fa fa-info-circle' ></i> <font style='font-size:0.9vw' >&nbsp&nbsp"+ curModelEntry["warning"] +" </font><br><br><input type='checkbox' id='noShowWarningId' onclick='onShowWarningCheck(this)' name='noShowWarning'><label for='noShowWarning'> Don't show </label>"
                                               
                                                 }
                                             }    


                                             let noShowTooltipStatus = fetchModelTooltipStatus();
                                             
                                             if(! noShowTooltipStatus) {                                     

                                                 if (curModelEntry["textureSize"] != 0) {
                                                    //--Compare model needed texture size and browser max texture size 
                                                    if(curModelEntry["textureSize"] > getMaxTextureSize()) {
                                                        $$("modelTooltip").show();

                                                        let warningMessage = "Current browser may not able to run selected model. " + curModelEntry["warning"];
                                                        // $$("modelTooltip").config.body.template = 
                                                        document.getElementById("tooltipDiv").innerHTML = 
                                                        "<i style='font-size:1.4vw'  class='fa fa-info-circle' ></i> <font style='font-size:0.77vw' >&nbsp&nbsp"+ warningMessage +" </font><br><br><input type='checkbox' id='noShowTooltipId'  name='noShowTooltip' onclick='onShowTooltipCheck(this)'><label for='noShowTooltip'> Don't show </label>"
                                                    }
                                                 }
                                             }    


                               } else {
                                      let modelEntry  = browserModelList.filter(entry => entry.id == this.getValue().toString())[0];
                                      if(! (modelEntry.modelFile && modelEntry.weightFile)) {

                                             $$("segmentBtn").disable();
                                      } 

                               }

                           }, 
                            onAfterRender: function() {
                               const modelEntry = selectModelOptions[this.getValue() - 1]; 

                               if(! modelEntry["path"]) {

                                      let modelEntry  = browserModelList.filter(entry => entry.id == this.getValue().toString())[0];
                                      if(! (modelEntry.modelFile && modelEntry.weightFile)) {

                                             $$("segmentBtn").disable();
                                      }         
                               }

                           }                   
                        }                
                      }, 


                      { 
                        view: "label", 
                        label: '<img src="style/info-circle-solid.svg"/>', 
                        css: {"color":"black !important", "font-weight": "bold", "cursor": "pointer"}, 
                        width: 25,
                        height: 25,
                        click: function() {
                                   getModelinfo();
                        }                        
                      } 
      
                  ]
              },   
     
              {  cols: [
                          {   
                            view: "label", label: "Inference",  
                            id: "segmentBtnLabel", 
                            align: "left"
                          },                 
                          { 
                            view: "button", label: "Run", 
                            css:"bt_1",
                            disabled: true,
                            id: "segmentBtn", 
                            align: "left",
                            click: function() {

                                       // test for requirement 
                                       let maxTextureAvail = getMaxTextureSize();
                                       let requiredTexture = inferenceModelsList[$$("selectModel").getValue() - 1]["textureSize"];
                                       if( maxTextureAvail >= requiredTexture ) {
                                           $$("downloadBtn").disable();
                                           $$("segmentBtn").disable();                                        
                                           runInference();
                                       } else {
                                         webix.alert("This model needs texture size of minimum " + requiredTexture + ", while current browser supports only " + maxTextureAvail); 
                                       }
                            }
                          }
                      ]    
              }, 
              { content: "progressBarDiv" , height:50}
              // { content: "subProgressBarDiv" , height:50}
          ]
       }



      // Welcome Window
      let welcomeWindowForm = {view: "form", id: "welcomeWindowFormId", elements: [ 

              {  cols: [
                    {   view: "template", template: " <img src='style/Artboard2.svg'  width='20%' align='right'>" + 
                       " <p align='justify'> Welcome to brainchop, a"+ " frontend" +" tool for  volumetric segmentation of neuroimaging that works locally on the user side.</p>" + 
                       " <p align='justify'> You're viewing a sample T1 (Left)  and its tissue segmentation (Right). Brainchop currenlty supports MRI Nifti file format. </p>" +  
                       "<p align='justify'> To see the tool in action please select a model from the list and run the inference. For more information on brainchop please refer to this <a href='https://github.com/neuroneural/brainchop/wiki/' target='_blank'><b> Wiki </b></a> and this <a href='https://trendscenter.org/in-browser-3d-mri-segmentation-brainchop-org/' target='_blank'><b> Blog</b></a>. For questions or sharing ideas please refere to our  <b><a href='https://github.com/neuroneural/brainchop/discussions/'  target='_blank'> Discussions </a></b> board. </p>" + 
                       "<input type='checkbox' id='noShowWelcomeWindow'  name='noShowWelcomeWindow'><label for='noShowWelcomeWindow'> Don't show again</label>",  
                        
                    }                 

                ]  
                
             },  
       

              {  cols: [
                        {}, 

                        { view:"button", value:"Ok", css:"bt_1", width:100,  
                                align:"center",
                                click: function() {
                                     $$("welcomeWindow").hide();
                                     webix.storage.local.put("showWelcomeScreen", ! document.getElementById("noShowWelcomeWindow").checked);
                               }
                        },

                        {}
                       ]
              } 

          ]
       }


    webix.ui({
      view:"popup",
      id: "modelTooltip",
      // head:"<i style='font-size:1.8vw'  class='fa fa-info-circle' ></i>",
        body:{
            template:"<div id='tooltipDiv'></div>"
        },
      position: function(state){
        state.width=state.maxWidth*20/100;
        state.height= state.maxHeight*15/100;
        state.left=(state.maxWidth-state.width)/1.01;
        state.top=(state.maxHeight-state.height)/1.1;
      }

    });


      // Welcome Window to select local model
      webix.ui({
                  view:"window",
                  id: "welcomeWindow",
                  height:370,
                  width:600,

                  head:{
                      view:"toolbar", css: "toolbarclass", elements:[
                          { type:"header", template:"Welcome", css:"windowtitleclass" },
                          { view:"icon", icon:"wxi-close", click:function(){
                              $$("welcomeWindow").hide();
                          } }
                      ]
                  },                  

                  position:"center",
                  body: welcomeWindowForm

      })

      fetchWelcomeScreenStatus = () => {
          return webix.storage.local.get("showWelcomeScreen");
      } 

      if(fetchWelcomeScreenStatus() == null || fetchWelcomeScreenStatus()) {
          $$("welcomeWindow").show();
      } else  {
          $$("welcomeWindow").hide();
      }




      let downloadNiftiFile = {view: "form", id: "downloadNiftiFileId", elements: [ 
              { type:"header", template:"Save Labels", 
                css:"headerclass"
              },

              {  cols: [
                    {   view: "label", label: "File Name",  
                        align: "left"
                    },                 
                    { view: "text", 
                      value: "labels.nii",  
                      id: "fileNameToDL", 
                      disabled: false,
                      align: "left",
                      on: {
                        onChange: function(newValue, oldValue, config) {
                          if(newValue.length && allOutputSlices3DCC1DimArray.length && isLetter(newValue[0])) {
                               $$("downloadBtn").enable();
                          } else {
                               $$("downloadBtn").disable();
                          }

                        }
                      }
                    }
                ]    
             },             

              {  cols: [
                    {   view: "label", label: "Labels",  
                        align: "left"
                    },                 
                    { view: "button", label: "Save",  
                      id: "downloadBtn", 
                      css: "bt_1",
                      disabled: true,
                      align: "left",
                      click: function() {  

                            if(allOutputSlices3DCC1DimArray.length) {
                                 let downloadFileName = $$("fileNameToDL").getValue();
                                 
                                 if(downloadFileName.search(".nii") < 0) { 
                                      // if nii extension doesn't exist, then search will return -1
                                      downloadFileName = downloadFileName + ".nii";
                                 }

                                 downloadNifti(allOutputSlices3DCC1DimArray, rawNiftiData, downloadFileName);

                            } else {
                                webix.message("No download Data");
                            }   
                      }  
                    }
                ]    
             }
          ]
       }




     let memoryView = {
                      view:"chart",
                      type:"barH",
                      id:"memoryMonitor",
                      width:120,
                      height:10,
                      value:"#memoryUse#",
                      gradient:function(gradient){
                        gradient.addColorStop(1.0,"#FF0000");
                        gradient.addColorStop(0.5,"#FFFF00");
                        gradient.addColorStop(0.0,"#00FF22");
                      },
                      alpha:0.8,
                      radius:2,
                      border:false,
                      xAxis:{
                        start:0,
                        end:100,
                        step:10,    
                        template:""
                      },
                      yAxis:{
                        template:""
                      }
                  }
    

      let hardwareStatus = {view: "form", id: "hardwareStatusId", elements: [ 
              { type:"header", template:"Status", 
                css: "headerclass"
              },

              {  cols: [
                    {   view: "label", label: "WebGL-2",  
                        align: "left"
                    },                 
                    { 
                      view: "label", label: "<span id='webGl2Status' style='background-color:none; padding-left:0.5vw;'>&nbsp&nbsp</span>",  align: "right" 
                    }
                ]    
             }, 

             {  cols: [
                    {   view: "label", label: "Memory",  
                        align: "left"
                    },  // memoryView              
                    { 
                      view: "label", label: "<span id='memoryStatus' style='background-color:none; padding-left:0.5vw;'>&nbsp&nbsp</span>", align: "right"  
                    }
                ]    
             }             
          ]
       }


       webix.ui({
          margin:5,
          rows:[toolbar,
          {
              margin:20,
              padding: 20,
              cols: [
                       { width: 250, margin:10,  rows:[
                                                        referenceImage,
                                                        Segmentation,
                                                        downloadNiftiFile,
                                                        hardwareStatus,
                                                        {}
                                                      ]
                       },
                       { rows: [ 
                                  { type:"header", template:"MRI  Viewer",
                                    css:"headerclass"
                                  },
                                  { view: "template", content: "papayaMriDiv", borderless:true},
                                
                               ]
                                     
                        },
                        {rows: [ 
                                      { type:"header", template:"Labels Viewer", 
                                        css: "headerclass"
                                      },
                                      { view: "template", content: "papayaLabelDiv", borderless:true},
                                                                          
                               ]
                      }                              
                  ]
            }],

        });


        //-- To excutes immediately after window loading
        //-- 0 for MRI viewer, 1 for Label viewer
        papayaContainers[0].preferences.smoothDisplay = 'Yes';
        papayaContainers[1].preferences.smoothDisplay = 'No';

        //-- papaya.Container.restartViewer(0, ["MRI/t1_c.nii.gz"], true);
        papaya.Container.restartViewer(1, ["MRI/labels.nii.gz"], true);  


        fetch('MRI/t1_c.nii.gz')
          .then((response) => {
            if (response.status >= 200 && response.status <= 299) {
              return response.blob();
            } else {
              throw Error(response.statusText);
            }
          })          
          .then(blob => {
                 let initFile = new File([blob], "initLoadFile.nii");

                 let reader = new FileReader();

                 reader.readAsArrayBuffer(initFile);  

                 reader.onload = evt => { 

                      params_mri["binaryImages"] = [evt.target.result];
                      papaya.Container.resetViewer(0, params_mri);  

                      let startTime = performance.now(); 
                      // decompress/check uploaded Nifti data
                      rawNiftiData = getNiftiRawData(evt.target.result);
                      niftiHeader = readNiftiHeader(rawNiftiData);
                      niftiImage = readNiftiImageData(niftiHeader, rawNiftiData);  

                      statData["Data_Load"] = ((performance.now() - startTime)/1000).toFixed(4);   

                      statData["File_Type"] = nifti.isNIFTI1(rawNiftiData) ? "NIFTI-1" : 
                                                                             nifti.isNIFTI2(rawNiftiData) ? "NIFTI-2" : "NOT-NIFTI"; 
                      statData["Img_Size"] = JSON.stringify([niftiHeader.dims[1], niftiHeader.dims[2], niftiHeader.dims[3]]);  
                      statData["Num_Bits_Per_Voxel"] = niftiHeader['numBitsPerVoxel'] ;
                      statData["Data_Type_Code"] = niftiHeader['datatypeCode'];
                      statData["Vox_Offset"] = niftiHeader['vox_offset'];
                      statData["Vox_1mm"] = isVoxelSize1mm(niftiHeader);
                      statData["File_Verified"] = isNiftiFileVerified(niftiHeader);


                      // // To sync swap view button 
                      // document.getElementById(PAPAYA_CONTROL_MAIN_SWAP_BUTTON_CSS + papayaContainers[0].containerIndex).addEventListener("click", function(){
                      //         papayaContainers[1].viewer.rotateViews()

                      // })

                     document.getElementById(PAPAYA_CONTROL_MAIN_SWAP_BUTTON_CSS + papayaContainers[0].containerIndex).disabled = true;

                      numOfOverlays = 0;                                                                                             
                      if(checkGPU()) {
                         $$("segmentBtn").enable();
                      }                      

                 }                          

        }).catch(function() {
                console.log("File not found");
                $$("segmentBtn").disable();
        });




       //--Activate annotation for papaya container 1- default    
       //-- addMouseMoveHandler(inferenceModelsList[$$("selectModel").getValue() - 1]["labelsPath"], 1);
       addMouseMoveHandler("./ModelToLoad/GT/labels.json", 1);


      document.getElementById(PAPAYA_CONTROL_MAIN_SWAP_BUTTON_CSS + papayaContainers[1].containerIndex).addEventListener("click", function(){
                 papayaContainers[0].viewer.rotateViews()

        })         

        

       

     })  




  </script>


    <div class="grid-container" id ="papayaMriDiv">
      <div class="grid-item" id="divMri">
        <div  class="papaya" data-params="params_mri"></div>
     </div>
      <div class="grid-item">
        <input type="text" id="annotOfContainer_0" disabled></div>
      </div>        
    </div>  

    <div class="grid-container" id ="papayaLabelDiv">
      <div class="grid-item">
        <div  class="papaya" data-params="params_label"></div>
      </div>
      <div class="grid-item">
        <input type="text" id="annotOfContainer_1" disabled></div>
      </div>      
    </div>  


    <div class="w3-container" style="margin-top: 1vh;" id="progressBarDiv" >
        <div class="w3-border" >
          <div class="w3-blue" style="height:2vh;width:0%;" id="progressBar"></div>
        </div>
    </div>
<!--     <div class="w3-container" style="margin-top: 1vh;" id="subProgressBarDiv" >
        <div class="w3-border" >
          <div class="w3-blue" style="height:2vh;width:0%;" id="subProgressBar"></div>
        </div>
    </div>  -->   


   <div style="height: 0vh; width: 0vw;" >
    <form method="post" autocomplete="off" name="google-sheet" id="googleSubForm" style="visibility: hidden;">
       <input type="text" name="Brainchop_Ver" id= "Brainchop_Ver"   />
       <input type="text" name="Country" id= "Country"   />
       <input type="text" name="State" id= "State"   />
       <input type="text" name="City" id= "City"   />       
       <input type="text" name="Date" id= "Date"   />
       <input type="text" name="Time" id= "Time"   />
       <input type="text" name="File_Name" id= "File_Name"   />   
       <input type="text" name="File_Type" id= "File_Type"   />         
       <input type="text" name="File_Verified" id= "File_Verified"   />        
       <input type="text" name="Img_Size" id= "Img_Size"   />       

       <input type="number" step=any name="Num_Bits_Per_Voxel" id= "Num_Bits_Per_Voxel"   /> 
       <input type="number" step=any name="Data_Type_Code" id= "Data_Type_Code"   />           
       <input type="number" step=any name="Vox_Offset" id= "Vox_Offset"   />
       <input type="text" name="Vox_1mm" id= "Vox_1mm"   />
       <input type="text" name="Resampled" id= "Resampled"   />

       <input type="text" name="Input_Shape" id= "Input_Shape"   />
       <input type="text" name="Output_Shape" id= "Output_Shape"   />
       <input type="text" name="Channel_Last" id= "Channel_Last"   />    
       <input type="number" step=any name="Model_Param" id= "Model_Param"   /> 
       <input type="number" step=any name="Model_Layers" id= "Model_Layers"   />           
       <input type="number" step=any name="No_SubVolumes" id= "No_SubVolumes"   />
       <input type="number" step=any name="Actual_Labels" id= "Actual_Labels"   />
       <input type="number" step=any name="Expect_Labels" id= "Expect_Labels"   />       
       <input type="text" name="NumLabels_Match" id= "NumLabels_Match"   />   
       <input type="number" step=any  name="Data_Load" id= "Data_Load"   />
       <input type="number" step=any  name="Preprocess_t" id= "Preprocess_t"  />
       <input type="number" step=any  name="Inference_t" id= "Inference_t"   />
       <input type="number" step=any  name="Merge_t" id= "Merge_t"   />
       <input type="number" step=any  name="Postprocess_t" id= "Postprocess_t"   />
       <input type="text" name="Model" id= "Model"   />
       <input type="text" name="Browser" id= "Browser"   />
       <input type="number" step=any  name="Browser_Ver" id= "Browser_Ver"   />       
       <input type="text" name="OS" id= "OS"   />
       <input type="number" step=any  name="Texture_Size" id= "Texture_Size" />
       <input type="number" step=any  name="Heap_Size_MB" id= "Heap_Size_MB" />
       <input type="number" step=any  name="Used_Heap_MB" id= "Used_Heap_MB" />
       <input type="number" step=any  name="Heap_Limit_MB" id= "Heap_Limit_MB" />                     
       <input type="text"  name="Status" id= "Status" />    
       <input type="text"  name="WebGL1" id= "WebGL1" />  
       <input type="text"  name="WebGL2" id= "WebGL2" />  
       <input type="text"  name="TF_Backend" id= "TF_Backend" />
       <input type="text"  name="GPU_Vendor" id= "GPU_Vendor" />  
       <input type="text"  name="GPU_Card" id= "GPU_Card" />   
       <input type="text"  name="GPU_Vendor_Full" id= "GPU_Vendor_Full" />  
       <input type="text"  name="GPU_Card_Full" id= "GPU_Card_Full" />                
       <input type="text"  name="Error_Type" id= "Error_Type" />  
       <input type="text"  name="Extra_Err_Info" id= "Extra_Err_Info" /> 
       <input type="number" step=any name="CPU_Cores" id= "CPU_Cores"   /> 
       <input type="submit" id="SubmitStatisticalData"  />
     </form>
    </div>

 </body>
</html>
